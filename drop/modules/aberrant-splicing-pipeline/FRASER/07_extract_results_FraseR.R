#'---
#' title: Results of FRASER analysis
#' author: Christian Mertes
#' wb:
#'  log:
#'    - snakemake: '`sm str(tmp_dir / "AS" / "{dataset}--{annotation}" / "07_results.Rds")`'
#'  params:
#'   - workingDir: '`sm cfg.getProcessedDataDir() + "/aberrant_splicing/datasets/"`'
#'   - outputDir: '`sm cfg.getProcessedResultsDir() + "/aberrant_splicing/datasets/"`'
#'   - padjCutoff: '`sm cfg.AS.get("padjCutoff")`'
#'   - zScoreCutoff: '`sm cfg.AS.get("zScoreCutoff")`'
#'   - deltaPsiCutoff: '`sm cfg.AS.get("deltaPsiCutoff")`'
#'   - hpoFile: '`sm cfg.get("hpoFile")`'
#'  threads: 10
#'  input:
#'   - setup: '`sm cfg.AS.getWorkdir() + "/config.R"`'
#'   - add_HPO_cols: '`sm str(projectDir / ".drop" / "helpers" / "add_HPO_cols.R")`'
#'   - fdsin: '`sm cfg.getProcessedDataDir() +
#'                 "/aberrant_splicing/datasets/savedObjects/{dataset}/" +
#'                 "padjBetaBinomial_theta.h5"`'
#'   - spliceTypeSetup: '`sm cfg.AS.getWorkdir() + "/spliceTypeConfig.R"`'
#'   - addAnnotation:  '`sm cfg.AS.getWorkdir() + "/fds_annotation.R"`'
#'   - addSpliceType: '`sm cfg.AS.getWorkdir() + "/spliceType_frameshift_annotation.R"`'
#'   - subtypes: '`sm cfg.AS.getWorkdir() + "/subtypes_exonSkipping_inconclusive.R"`'
#'   - annotate_blacklist: '`sm str(projectDir / ".drop" / "helpers" / "annotate_blacklist.R")`'
#'   - blacklist_19: '`sm str(projectDir / ".drop" / "helpers" / "resource" / "hg19-blacklist.v2.bed.gz")`'
#'   - blacklist_38: '`sm str(projectDir / ".drop" / "helpers" / "resource" / "hg38-blacklist.v2.bed.gz")`'
#'   - txdb: '`sm cfg.getProcessedDataDir() + "/preprocess/{annotation}/txdb.db"`'
#'   - gene_name_mapping: '`sm cfg.getProcessedDataDir() + "/preprocess/{annotation}/gene_name_mapping_{annotation}.tsv"`'
#'  output:
#'   - resultTableJunc: '`sm cfg.getProcessedResultsDir() +
#'                          "/aberrant_splicing/results/{annotation}/fraser/{dataset}/results_per_junction.tsv"`'
#'   - resultTableGene: '`sm cfg.getProcessedResultsDir() +
#'                          "/aberrant_splicing/results/{annotation}/fraser/{dataset}/results.tsv"`'
#'   - fds: '`sm cfg.getProcessedResultsDir() +
#'                 "/aberrant_splicing/datasets/savedObjects/{dataset}--{annotation}/fds-object.RDS"`'
#'  type: script
#'---

saveRDS(snakemake, snakemake@log$snakemake)
source(snakemake@input$setup, echo=FALSE)
source(snakemake@input$add_HPO_cols)
source(snakemake@input$spliceTypeSetup, echo=FALSE)
source(snakemake@input$addAnnotation)
source(snakemake@input$addSpliceType)
source(snakemake@input$subtypes)
source(snakemake@input$annotate_blacklist)
library(AnnotationDbi)

annotation    <- snakemake@wildcards$annotation
dataset    <- snakemake@wildcards$dataset
fdsFile    <- snakemake@input$fdsin
workingDir <- snakemake@params$workingDir
outputDir  <- snakemake@params$outputDir

register(MulticoreParam(snakemake@threads))
# Limit number of threads for DelayedArray operations
setAutoBPPARAM(MulticoreParam(snakemake@threads))

# Load fds and create a new one
fds_input <- loadFraserDataSet(dir=workingDir, name=dataset)

# Read annotation and match the chr style
txdb <- loadDb(snakemake@input$txdb)
orgdb <- fread(snakemake@input$gene_name_mapping)

seqlevels_fds <- seqlevelsStyle(fds_input)[1]
seqlevelsStyle(orgdb$seqnames) <- seqlevels_fds
seqlevelsStyle(txdb) <- seqlevels_fds

# Annotate the fds with gene names and save it as a new object
fds_input <- annotateRangesWithTxDb(fds_input, txdb = txdb, orgDb = orgdb, 
                                    feature = 'gene_name', featureName = 'hgnc_symbol', keytype = 'gene_id')

fds <- saveFraserDataSet(fds_input, dir=outputDir, name = paste(dataset, annotation, sep = '--'), rewrite = TRUE)

# Add the junction annotations to the fds
fds <- createFDSAnnotations(fds, txdb)
#print(rowRanges(fds,type="j"))

mcols(fds, type="ss")$annotatedJunction <-  "none"
#print(rowRanges(fds, type="ss"))

# Extract results per junction
res_junc <- results(fds,
                    padjCutoff=snakemake@params$padjCutoff,
                    zScoreCutoff=snakemake@params$zScoreCutoff,
                    deltaPsiCutoff=snakemake@params$deltaPsiCutof,
                    additionalColumns="annotatedJunction")
res_junc_dt   <- as.data.table(res_junc)
print('Results per junction extracted')
saveFraserDataSet(fds, dir=outputDir)
#print(res_junc_dt)


# Add features
if(nrow(res_junc_dt) > 0){

  # number of samples per gene and variant
  res_junc_dt[, numSamplesPerGene := uniqueN(sampleID), by = hgncSymbol]
  res_junc_dt[, numEventsPerGene := .N, by = "hgncSymbol,sampleID"]
  res_junc_dt[, numSamplesPerJunc := uniqueN(sampleID), by = "seqnames,start,end,strand"]

  # add colData to the results
  res_junc_dt <- merge(res_junc_dt, as.data.table(colData(fds)), by = "sampleID")
  res_junc_dt[, c("bamFile", "pairedEnd") := NULL]
  setnames(res_junc_dt, 'STRAND', 'STRAND_SPECIFIC')  # otherwise it's confusing with the 'strand' column from the junction
} else{
  warning("The aberrant splicing pipeline gave 0 results for the ", dataset, " dataset.")
}


# Aggregate results by gene
if(length(res_junc) > 0){
  res_genes_dt <- resultsByGenes(res_junc) %>% as.data.table
  res_genes_dt <- merge(res_genes_dt, as.data.table(colData(fds)), by = "sampleID")
  res_genes_dt[, c("bamFile", "pairedEnd") := NULL]
  setnames(res_genes_dt, 'STRAND', 'STRAND_SPECIFIC')
  
  # add HPO overlap information
  sa <- fread(snakemake@config$sampleAnnotation)
  if(!is.null(sa$HPO_TERMS)){
    if(!all(is.na(sa$HPO_TERMS)) & ! all(sa$HPO_TERMS == '')){
      res_genes_dt <- add_HPO_cols(res_genes_dt, hpo_file = snakemake@params$hpoFile)
    }
  }
} else res_genes_dt <- data.table()


# Add the annotation
#res_junc_dt <- createAnnotation(res_junc_dt, fds, txdb)
#print(res_junc_dt)

# Calculate splice types and frameshift
res_junc_dt <- aberrantSpliceType(res_junc_dt, fds, txdb)

# Add the subtypes for exonSkipping and inconclusive
res_junc_dt <- checkExonSkipping(res_junc_dt, txdb)
res_junc_dt <- checkInconclusive(res_junc_dt, txdb)

# Add UTR labels
res_junc_dt <- addUTRLabels(res_junc_dt, txdb)

# Add blacklist labels
if(assemblyVersion == 37){
  print("version 37")
  blacklist_gr <- import(snakemake@input$blacklist_19, format = "BED")
}else{
  blacklist_gr <- import(snakemake@input$blacklist_38, format = "BED")
}
res_junc_dt <- addBlacklistLabels(res_junc_dt, blacklist_gr, "splicing")

# Results
write_tsv(res_junc_dt, file=snakemake@output$resultTableJunc)
write_tsv(res_genes_dt, file=snakemake@output$resultTableGene)
